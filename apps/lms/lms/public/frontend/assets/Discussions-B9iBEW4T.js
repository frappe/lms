import{J as z,K as O,r as $,i as R,o as F,A as x,e as p,f as r,k,j as P,h as c,g as a,n as T,l as e,a0 as I,_ as S,t as m,F as B,x as L,aF as A,aQ as W,aR as X,p as E,aG as U,C as H,H as G,L as Y,q as Z,aS as J,M as ee,aT as te,N as se}from"./index-D24HXhLT.js";import{_ as K}from"./UserAvatar-CNqvj4u9.js";const oe={class:"mt-6"},ae={key:0,class:"flex items-center mb-5"},le={class:"text-lg font-semibold ml-2 text-ink-gray-9"},ne={class:"flex items-center justify-between mb-2"},re={class:"flex items-center text-ink-gray-5"},ie={class:"text-sm ml-2"},de={key:1},ce={key:2,class:"flex justify-between mt-2"},N={__name:"DiscussionReplies",props:z({topic:{type:Object,required:!0},singleThread:{type:Boolean,default:!1}},{showTopics:{},showTopicsModifiers:{}}),emits:["update:showTopics"],setup(n){const _=O(n,"showTopics"),v=$(""),i=R("$socket"),w=R("$user"),h=R("$allUsers"),C=$([]),l=$(!1),d=window.read_only_mode,s=n;F(()=>{i.on("publish_message",t=>{b.reload()}),i.on("update_message",t=>{b.reload()}),i.on("delete_message",t=>{b.reload()}),y()});const b=x({url:"lms.lms.utils.get_discussion_replies",cache:["replies",s.topic],makeParams(t){return{topic:s.topic.name}},auto:!0}),V=x({url:"frappe.client.insert",makeParams(t){return{doc:{doctype:"Discussion Reply",reply:v.value,topic:s.topic.name}}}}),y=()=>{var t;(t=w.data)!=null&&t.is_student?l.value=!0:h.reload({},{onSuccess(f){C.value=Object.values(f).map(o=>({value:o.name,label:o.full_name})),l.value=!0}})},g=()=>{V.submit({},{validate(){if(!v.value)return"Reply cannot be empty"},onSuccess(){v.value="",b.reload()},onError(t){var f;G.error(((f=t.messages)==null?void 0:f[0])||t)}})},M=x({url:"frappe.client.set_value",makeParams(t){return{doctype:"Discussion Reply",name:t.name,fieldname:"reply",value:t.reply}}}),u=t=>{M.submit({name:t.name,reply:t.reply},{validate(){if(!t.reply)return"Reply cannot be empty"},onSuccess(){t.editable=!1,b.reload()}})},q=x({url:"frappe.client.delete",makeParams(t){return{doctype:"Discussion Reply",name:t.name}}}),j=t=>{q.submit({name:t.name},{onSuccess(){b.reload()}})};return(t,f)=>(r(),p("div",oe,[n.singleThread?k("",!0):(r(),p("div",ae,[c(e(S),{variant:"outline",onClick:f[0]||(f[0]=o=>_.value=!0)},{icon:T(()=>[c(e(I),{class:"w-5 h-5 stroke-1.5 text-ink-gray-7"})]),_:1}),a("span",le,m(n.topic.title),1)])),(r(!0),p(B,null,L(e(b).data,(o,Q)=>(r(),p("div",null,[a("div",{class:H(["py-3",{"border-b":Q+1!=e(b).data.length}])},[a("div",ne,[a("div",re,[c(K,{user:o.user,class:"mr-2"},null,8,["user"]),a("span",null,m(o.user.full_name),1),a("span",ie,m(e(A)(o.creation)),1)]),e(w).data.name==o.owner&&!o.editable&&!e(d)?(r(),P(e(X),{key:0,options:[{label:"Edit",onClick(){o.editable=!0}},{label:"Delete",onClick(){j(o)}}]},{default:T(({open:D})=>[c(e(W),{class:"w-4 h-4 stroke-1.5 cursor-pointer"})]),_:2},1032,["options"])):k("",!0),o.editable?(r(),p("div",de,[c(e(S),{variant:"ghost",onClick:D=>u(o)},{default:T(()=>[E(m(t.__("Post")),1)]),_:2},1032,["onClick"]),c(e(S),{variant:"ghost",onClick:D=>o.editable=!1},{default:T(()=>[E(m(t.__("Discard")),1)]),_:2},1032,["onClick"])])):k("",!0)]),c(e(U),{content:o.reply,onChange:D=>o.reply=D,editable:o.editable||!1,fixedMenu:o.editable||!1,editorClass:o.editable?"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none":"prose-sm"},null,8,["content","onChange","editable","fixedMenu","editorClass"])],2)]))),256)),l.value&&!e(d)?(r(),P(e(U),{key:1,class:"mt-5",content:v.value,mentions:C.value,onChange:f[1]||(f[1]=o=>v.value=o),placeholder:"Type your reply here...",fixedMenu:!0,editorClass:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none border border-outline-gray-2 rounded-b-md min-h-[7rem] py-1 px-2"},null,8,["content","mentions"])):k("",!0),e(d)?k("",!0):(r(),p("div",ce,[f[3]||(f[3]=a("span",null,null,-1)),c(e(S),{onClick:f[2]||(f[2]=o=>g())},{default:T(()=>[a("span",null,m(t.__("Post")),1)]),_:1})]))]))}},ue={class:"flex flex-col gap-4"},pe={class:"mb-1.5 text-sm text-ink-gray-5"},me={__name:"DiscussionModal",props:z({title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0}},{reloadTopics:{},reloadTopicsModifiers:{}}),emits:["update:reloadTopics"],setup(n){const _=O(n,"reloadTopics"),v=n,i=Y({title:"",reply:""}),w=x({url:"frappe.client.insert",makeParams(l){return{doc:{doctype:"Discussion Topic",reference_doctype:v.doctype,reference_docname:v.docname,title:i.title}}}}),h=x({url:"frappe.client.insert",makeParams(l){return{doc:{doctype:"Discussion Reply",topic:l.topic,reply:i.reply}}}}),C=l=>{w.submit({},{validate(){if(!i.title)return"Title cannot be empty.";if(!i.reply)return"Reply cannot be empty."},onSuccess(d){h.submit({topic:d.name},{onSuccess(){i.title="",i.reply="",_.value.reload(),l()}})},onError(d){var s;G.error(((s=d.messages)==null?void 0:s[0])||d)}})};return(l,d)=>(r(),P(e(ee),{options:{title:e(J)(v.title),size:"2xl",actions:[{label:"Post",variant:"solid",onClick:s=>C(s)}]}},{"body-content":T(()=>[a("div",ue,[a("div",null,[c(e(Z),{modelValue:i.title,"onUpdate:modelValue":d[0]||(d[0]=s=>i.title=s),label:l.__("Title"),type:"text"},null,8,["modelValue","label"])]),a("div",null,[a("div",pe,m(l.__("Details")),1),c(e(U),{content:i.reply,onChange:d[1]||(d[1]=s=>i.reply=s),editable:!0,fixedMenu:!0,editorClass:"prose-sm max-w-none border-b border-x bg-surface-gray-2 rounded-b-md py-1 px-2 min-h-[7rem]"},null,8,["content"])])])]),_:1},8,["options"]))}};function ye(){return window.scrollContainer}const fe={class:"text-xl font-semibold text-ink-gray-9"},ve={key:0},be=["onClick"],ge={class:"text-lg font-semibold mb-1 text-ink-gray-7"},_e={class:"flex items-center text-ink-gray-5"},he={class:"text-sm ml-3"},ke={key:1},Te={key:1},xe={key:2,class:"flex flex-col items-center justify-center border-2 border-dashed mt-5 py-8 rounded-md"},we={class:""},Ce={key:0,class:"font-medium mb-2"},$e={class:"text-ink-gray-5"},Me={__name:"Discussions",props:{title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0},emptyStateTitle:{type:String,default:""},emptyStateText:{type:String,default:"Start a discussion"},singleThread:{type:Boolean,default:!1},scrollToBottom:{type:Boolean,default:!1}},setup(n){const _=$(!0),v=$(null),i=R("$socket"),w=R("$user"),h=$(!1),C=window.read_only_mode,l=n;F(()=>{w.data&&s.reload(),i.on("new_discussion_topic",y=>{s.refresh()}),l.scrollToBottom&&setTimeout(()=>{d()},100)});const d=()=>{let y=ye();y.scrollTop=y.scrollHeight},s=x({url:"lms.lms.utils.get_discussion_topics",cache:["topics",l.doctype,l.docname],makeParams(){return{doctype:l.doctype,docname:l.docname,single_thread:l.singleThread}}}),b=y=>{_.value=!1,v.value=y},V=()=>{h.value=!0};return(y,g)=>{var M;return r(),p(B,null,[a("div",null,[!n.singleThread&&!e(C)?(r(),P(e(S),{key:0,class:"float-right",onClick:g[0]||(g[0]=u=>V())},{default:T(()=>[E(m(y.__("New {0}").format(e(J)(n.title))),1)]),_:1})):k("",!0),a("div",fe,m(y.__(n.title)),1)]),(M=e(s).data)!=null&&M.length&&!n.singleThread?(r(),p("div",ve,[_.value?(r(!0),p(B,{key:0},L(e(s).data,(u,q)=>(r(),p("div",null,[a("div",{onClick:j=>b(u),class:H(["flex items-center cursor-pointer py-5 w-full",{"border-b":q+1!=e(s).data.length}])},[c(K,{user:u.user,size:"2xl",class:"mr-4"},null,8,["user"]),a("div",null,[a("div",ge,m(u.title),1),a("div",_e,[a("span",null,m(u.user.full_name),1),a("span",he,m(e(A)(u.creation)),1)])])],10,be)]))),256)):(r(),p("div",ke,[c(N,{topic:v.value,showTopics:_.value,"onUpdate:showTopics":g[1]||(g[1]=u=>_.value=u)},null,8,["topic","showTopics"])]))])):n.singleThread&&e(s).data?(r(),p("div",Te,[c(N,{topic:e(s).data,singleThread:n.singleThread},null,8,["topic","singleThread"])])):(r(),p("div",xe,[c(e(te),{class:"w-7 h-7 text-ink-gray-4 stroke-1.5 mr-2"}),a("div",we,[n.emptyStateTitle?(r(),p("div",Ce,m(y.__(n.emptyStateTitle)),1)):k("",!0),a("div",$e,m(y.__(n.emptyStateText)),1)])])),c(me,{modelValue:h.value,"onUpdate:modelValue":g[2]||(g[2]=u=>h.value=u),title:y.__("New {0}").format(n.title),doctype:l.doctype,docname:l.docname,reloadTopics:e(s),"onUpdate:reloadTopics":g[3]||(g[3]=u=>se(s)?s.value=u:null)},null,8,["modelValue","title","doctype","docname","reloadTopics"])],64)}}};export{Me as _};
//# sourceMappingURL=Discussions-B9iBEW4T.js.map
